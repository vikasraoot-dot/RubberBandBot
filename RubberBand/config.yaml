# === RubberBand/config.yaml ===

# ──────────────────────────────────────────────────────────────────────────────
# INTERVALS / PERIODS
# ──────────────────────────────────────────────────────────────────────────────
intervals: ["15m"]
periods:
  "15m": "10d"

# ──────────────────────────────────────────────────────────────────────────────
# SESSION / DATA
# ──────────────────────────────────────────────────────────────────────────────
timezone: "US/Eastern"
rth_only: true
rth_start: "09:30"
rth_end:   "15:55"

# Entry Windows (Eastern Time) - Avoid first 15m volatility
entry_windows:
  - start: "09:45"
    end: "15:45"

bar_limit: 10000
feed: "iex"

run:
  force_run: 0

# ──────────────────────────────────────────────────────────────────────────────
# INDICATORS
# ──────────────────────────────────────────────────────────────────────────────
keltner_length: 20
keltner_mult: 1.5
atr_length: 14
atr_length: 14
rsi_length: 14

# Slope Filter (Dual-Slope "Panic Persistency")
# Logic: We SKIP trades that are NOT crashing fast enough.
# Slope_3 checks immediate crash (45m lookback). Slope_10 checks sustained crash (2.5h).
# Values > threshold = SKIP (too flat/slow bleed).
slope_threshold: -0.20      # 3-bar slope: Must be <= -0.20 (steep crash)
# slope_threshold_10: -0.15   # DISABLED: Was blocking valid entries. Live bot doesn't use this.
# ──────────────────────────────────────────────────────────────────────────────
# RISK CONTROLS
# ──────────────────────────────────────────────────────────────────────────────
flatten_minutes_before_close: 15
entry_cutoff_min: 20

# RESILIENCE (Dynamic Circuit Breaker)
resilience:
  enabled: true
  lookback_trades: 5        # Check last 5 trades
  max_consecutive_losses: 3 # Pause if 3 losses in a row
  drawdown_threshold_usd: -100.0 # Pause if net loss < -$100 in lookback
  probation_period_days: 7  # How long to stay paused
  
trend_filter:
  enabled: true
  sma_period: 100   # Optimization: 100-day SMA captures All-Weather trends (was 20)

# POSITION / SIZING
allow_shorts: false
qty: 10000
max_shares_per_trade: 10000
max_notional_per_trade: 2000
max_open_trades_per_ticker: 1

# ──────────────────────────────────────────────────────────────────────────────
# BRACKET ORDERS
# ──────────────────────────────────────────────────────────────────────────────
brackets:
  enabled: true
  atr_mult_sl: 1.5          # Stop Loss = 1.5 ATR (matches live workflow env var SL_ATR)
  take_profit_r: 2.0        # Take Profit = 2.0 ATR → R:R = 1.33:1

# Breakeven (Optional)
breakeven:
  enabled: true
  trigger_r: 1.0            # Move to BE at 1.0 R
  bump_ticks: 2
  tick_size: 0.01

# ──────────────────────────────────────────────────────────────────────────────
# FILTERS / GATES
# ──────────────────────────────────────────────────────────────────────────────
filters:
  rsi_oversold: 30           # Buy when RSI < 30 (Golden Mean for Options Volume)
  rsi_overbought: 70         # (Future use for shorts)
  min_price: 5.0
  min_dollar_vol: 1000000    # Adjusted for IEX feed volume
  trend_filter_sma: 0        # Disabled (Too restrictive)
  # Filter overrides to allow mean reversion (RSI < 25)
  rsi_min: 15
  rsi_max: 100
  # adx_threshold: 80        # REMOVED (Dead code)
  slope_threshold: -0.12     # Optimized Panic Entry (was -0.001) - 3-bar slope
  # slope_threshold_10: -0.05 # Optional: 10-bar sustained slope (disabled by default)
  require_fast_above_slow: false # Allow deep dips where fast EMA crosses slow
  dead_knife_filter: false    # DISABLED for Normal Regime (Re-enabled automatically in PANIC)
  bearish_bar_filter: false   # DISABLED (Restores volume for Options Bot)

# ──────────────────────────────────────────────────────────────────────────────
# EXIT STRATEGY
# ──────────────────────────────────────────────────────────────────────────────
# NOTE: Live bot ONLY uses Brackets (TP/SL). 
# We disable these "smart exits" in backtest to match live reality.
exit_at_mean: false
exit_at_upper: false

# ──────────────────────────────────────────────────────────────────────────────
# OUTPUT
# ──────────────────────────────────────────────────────────────────────────────
results_dir: "results"

# ──────────────────────────────────────────────────────────────────────────────
# BROKER
# ──────────────────────────────────────────────────────────────────────────────
broker:
  base_url: "https://paper-api.alpaca.markets"
  key: ""
  secret: ""
