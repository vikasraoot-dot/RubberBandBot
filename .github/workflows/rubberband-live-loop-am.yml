name: "[BOT] 15m Stock - Live"
on:
  schedule:
    # Fire 30 mins BEFORE market open (9:00 AM EST)
    # 14:00 UTC = 9:00 AM EST (Winter) / 10:00 AM EDT (Summer)
    # The wait guard will hold until market actually opens
    - cron: "0 14 * * 1-5"
  workflow_dispatch:
    inputs:
      slope_threshold:
        description: 'Slope Threshold (e.g. -0.20, leave empty to use config.yaml)'
        required: false
        default: '-0.20'

concurrency:
  group: rubberband-live-paper-loop-am
  cancel-in-progress: true

jobs:
  trade:
    runs-on: [self-hosted, windows]
    timeout-minutes: 600

    steps:
      - uses: actions/checkout@v4

      - name: Ensure Python path
        shell: powershell
        run: |
          $python = (Get-Command python.exe).Source
          echo "PYTHON_EXE=$python" >> $env:GITHUB_ENV

      - name: Install deps
        shell: powershell
        run: |
          & "$env:PYTHON_EXE" -m pip install --upgrade pip
          & "$env:PYTHON_EXE" -m pip install -r RubberBand/requirements.txt

      - name: Download Position Registry
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: position-registry-15M_STK
          path: .position_registry/

      # Wait guard so the loop begins right at the bell, even if cron is early/late
      - name: Wait until market open (guard)
        shell: powershell
        env:
          APCA_BASE_URL: https://paper-api.alpaca.markets
          APCA_API_KEY_ID: ${{ secrets.ALPACA_KEY_ID }}
          APCA_API_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
        run: |
          chcp 65001 > $null
          $H = @{ "APCA-API-KEY-ID" = "${env:APCA_API_KEY_ID}"; "APCA-API-SECRET-KEY" = "${env:APCA_API_SECRET_KEY}" }
          function Get-Clock {
            Invoke-RestMethod -Uri "$env:APCA_BASE_URL/v2/clock" -Headers $H -TimeoutSec 8
          }
          $maxWaitMin = 20
          $start = Get-Date
          while ($true) {
            try {
              $clk = Get-Clock
              if ($clk.is_open) { Write-Host "Market is open â†’ proceed."; break }
              $now = [DateTimeOffset]::UtcNow
              $nextOpen = [DateTimeOffset]::Parse($clk.next_open)
              if ($now -lt $nextOpen) {
                $sec = [int][Math]::Min(30, ($nextOpen - $now).TotalSeconds)
                Write-Host "Waiting $sec s until next_open $($clk.next_open)..."
                Start-Sleep -Seconds $sec
              } else {
                Write-Host "Past next_open window; continuing."
                break
              }
              if ((Get-Date) - $start -gt (New-TimeSpan -Minutes $maxWaitMin)) {
                Write-Host "Exceeded $maxWaitMin min wait. Continuing."
                break
              }
            } catch {
              Write-Host "Clock check failed: $($_.Exception.Message). Retrying in 15s..."
              Start-Sleep -Seconds 15
            }
          }

      - name: Run market loop (paper trading)
        shell: powershell
        env:
          APCA_BASE_URL: https://paper-api.alpaca.markets
          APCA_API_KEY_ID: ${{ secrets.ALPACA_KEY_ID }}
          APCA_API_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
          ALPACA_KEY: ${{ secrets.ALPACA_KEY_ID }}
          ALPACA_SECRET: ${{ secrets.ALPACA_SECRET_KEY }}
          DRY_RUN: "0"
          FORCE_RUN: "0"
          SLOPE_THRESHOLD: ${{ github.event.inputs.slope_threshold }}
          RSI_ENTRY: "25"
          TP_R: "2.0"
          SL_ATR: "1.5"
          PYTHONUNBUFFERED: "1"
        run: |
          chcp 65001 > $null
          $env:PYTHONPATH = "$env:GITHUB_WORKSPACE"
          & "$env:PYTHON_EXE" -X utf8 -u RubberBand/scripts/market_loop.py

      - name: Upload Position Registry
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: position-registry-15M_STK
          path: .position_registry/
          retention-days: 90
          overwrite: true