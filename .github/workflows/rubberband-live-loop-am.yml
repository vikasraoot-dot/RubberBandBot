name: "[BOT] 15m Stock - Live"
on:
  schedule:
    # Fire 30 mins BEFORE market open (9:00 AM EST)
    # 14:00 UTC = 9:00 AM EST (Winter) / 10:00 AM EDT (Summer)
    # The wait guard will hold until market actually opens
    - cron: "0 14 * * 1-5"
  workflow_dispatch:
    inputs:
      slope_threshold:
        description: 'Slope Threshold 3-bar (e.g. -0.20, leave empty to use config.yaml)'
        required: false
        default: '-0.20'
      slope_threshold_10:
        description: 'Slope Threshold 10-bar (e.g. -0.15, leave empty to use config.yaml)'
        required: false
        default: '-0.15'

concurrency:
  group: rubberband-live-paper-loop-am
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  trade:
    runs-on: [self-hosted, windows]
    timeout-minutes: 600

    steps:
      - uses: actions/checkout@v4

      - name: Ensure Python path
        shell: powershell
        run: |
          # Hardcoded path for self-hosted Windows runners (services don't inherit PATH)
          $python = "C:\Python313\python.exe"
          if (-not (Test-Path $python)) {
            # Fallback to dynamic detection if hardcoded path doesn't exist
            $python = (Get-Command python.exe -ErrorAction SilentlyContinue).Source
            if (-not $python) { throw "Python not found!" }
          }
          echo "PYTHON_EXE=$python" >> $env:GITHUB_ENV

      - name: Install deps
        shell: powershell
        run: |
          & "$env:PYTHON_EXE" -m pip install --upgrade pip
          & "$env:PYTHON_EXE" -m pip install -r RubberBand/requirements.txt

      # Position registry is persisted via git commits (GAP-008 fix)
      # The bot commits registry changes during trading to auditor_logs/
      # checkout@v4 above retrieves the latest registry from git automatically
      # Artifact-based download was removed as it only works within same workflow run

      # Wait guard so the loop begins right at the bell, even if cron is early/late
      - name: Wait until market open (guard)
        shell: powershell
        env:
          APCA_BASE_URL: https://paper-api.alpaca.markets
          APCA_API_KEY_ID: ${{ secrets.ALPACA_KEY_ID }}
          APCA_API_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
        run: |
          chcp 65001 > $null
          $H = @{ "APCA-API-KEY-ID" = "${env:APCA_API_KEY_ID}"; "APCA-API-SECRET-KEY" = "${env:APCA_API_SECRET_KEY}" }
          function Get-Clock {
            Invoke-RestMethod -Uri "$env:APCA_BASE_URL/v2/clock" -Headers $H -TimeoutSec 8
          }
          $maxWaitMin = 20
          $start = Get-Date
          while ($true) {
            try {
              $clk = Get-Clock
              if ($clk.is_open) { Write-Host "Market is open â†’ proceed."; break }
              $now = [DateTimeOffset]::UtcNow
              $nextOpen = [DateTimeOffset]::Parse($clk.next_open)
              if ($now -lt $nextOpen) {
                $sec = [int][Math]::Min(30, ($nextOpen - $now).TotalSeconds)
                Write-Host "Waiting $sec s until next_open $($clk.next_open)..."
                Start-Sleep -Seconds $sec
              } else {
                Write-Host "Past next_open window; continuing."
                break
              }
              if ((Get-Date) - $start -gt (New-TimeSpan -Minutes $maxWaitMin)) {
                Write-Host "Exceeded $maxWaitMin min wait. Continuing."
                break
              }
            } catch {
              Write-Host "Clock check failed: $($_.Exception.Message). Retrying in 15s..."
              Start-Sleep -Seconds 15
            }
          }

      - name: Run market loop (paper trading)
        shell: powershell
        env:
          APCA_BASE_URL: https://paper-api.alpaca.markets
          APCA_API_KEY_ID: ${{ secrets.ALPACA_KEY_ID }}
          APCA_API_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
          ALPACA_KEY: ${{ secrets.ALPACA_KEY_ID }}
          ALPACA_SECRET: ${{ secrets.ALPACA_SECRET_KEY }}
          DRY_RUN: "0"
          FORCE_RUN: "0"
          SLOPE_THRESHOLD: ${{ github.event.inputs.slope_threshold }}
          SLOPE_THRESHOLD_10: ${{ github.event.inputs.slope_threshold_10 }}
          RSI_ENTRY: "25"
          TP_R: "2.0"
          SL_ATR: "1.5"
          PYTHONUNBUFFERED: "1"
        run: |
          git config user.email "bot@rubberband.local"
          git config user.name "RubberBandBot"
          chcp 65001 > $null
          $env:PYTHONPATH = "$env:GITHUB_WORKSPACE"
          # NOTE: We run market_loop.py (wrapper) which calls live_paper_loop.py (logic).
          # Any new env vars (like SLOPE_THRESHOLD_10) MUST be passed explicitly in market_loop.py's run_once()!
          & "$env:PYTHON_EXE" -X utf8 -u RubberBand/scripts/market_loop.py *>&1 | Tee-Object -FilePath "console.log"

      # Backup: Upload registry as artifact (primary persistence is via git commits)
      - name: Upload Position Registry (backup)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: position-registry-15M_STK
          path: .position_registry/
          retention-days: 90
          overwrite: true

      - name: Upload Console Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: 15m-stock-console-log-${{ github.run_id }}
          path: console.log
          if-no-files-found: warn
          retention-days: 30

