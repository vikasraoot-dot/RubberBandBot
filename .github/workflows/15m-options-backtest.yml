name: "[BACKTEST] 15m Options"

on:
  workflow_dispatch:
    inputs:
      days:
        description: 'Backtest period (days)'
        required: false
        default: '30'
        type: string
      dte:
        description: 'Days to expiration (1-3)'
        required: false
        default: '2'
        type: string
      spread_width:
        description: 'Spread width in ATR multiples'
        required: false
        default: '1.5'
        type: string
      sma_period:
        description: 'SMA period for trend filter (20=short, 50=medium)'
        required: false
        default: '20'
        type: string
      max_debit:
        description: 'Max debit per share ($)'
        required: false
        default: '2.0'
        type: string
      tickers:
        description: 'Ticker file path'
        required: false
        default: 'RubberBand/tickers_options.txt'
        type: string
      verbose:
        description: 'Enable detailed trade logging'
        required: false
        default: false
        type: boolean
      flatten_eod:
        description: 'Flatten at end of day (no overnight holds)'
        required: false
        default: false
        type: boolean
      bars_stop:
        description: 'Time stop: exit after N bars (0=disabled, default=10)'
        required: false
        default: '10'

        type: string
      slope_threshold:
        description: 'Slope Threshold 3-bar (e.g. -0.20, leave empty to use config)'
        required: false
        default: ''
        type: string
      slope_threshold_10:
        description: 'Slope Threshold 10-bar (e.g. -0.15, leave empty to use config)'
        required: false
        default: ''
        type: string
      adx_max:
        description: 'Max ADX to allow entry (0=disabled, try 50-60)'
        required: false
        default: '0'
        type: string
      sl_pct:
        description: 'Stop Loss % (e.g. 0.80 for 80%)'
        required: false
        default: '0.80'
        type: string

jobs:
  backtest:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r RubberBand/requirements.txt

      - name: Run 15-Minute Options Spread Backtest
        env:
          APCA_API_KEY_ID: ${{ secrets.ALPACA_KEY_ID }}
          APCA_API_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
          APCA_API_BASE_URL: https://paper-api.alpaca.markets
        run: |
          echo "=========================================="
          echo "15-Minute Options Spread Backtest"
          echo "=========================================="
          echo "Period: ${{ github.event.inputs.days || '30' }} days"
          echo "DTE: ${{ github.event.inputs.dte || '6' }}"
          echo "Spread Width: ${{ github.event.inputs.spread_width || '1.5' }} ATR"
          echo "SMA Period: ${{ github.event.inputs.sma_period || '20' }}"
          echo "Max Debit: ${{ github.event.inputs.max_debit || '2.0' }}"
          echo "Slope Threshold: ${{ github.event.inputs.slope_threshold || 'DISABLED' }}"
          echo "Tickers: ${{ github.event.inputs.tickers || 'RubberBand/tickers_options.txt' }}"
          echo "=========================================="
          
          # Construct slope arg only if input is present
          SLOPE_ARG=""
          if [ -n "${{ github.event.inputs.slope_threshold }}" ]; then
            SLOPE_ARG="--slope-threshold ${{ github.event.inputs.slope_threshold }}"
          fi
          
          SLOPE10_ARG=""
          if [ -n "${{ github.event.inputs.slope_threshold_10 }}" ]; then
            SLOPE10_ARG="--slope-threshold-10 ${{ github.event.inputs.slope_threshold_10 }}"
          fi

          python RubberBand/scripts/backtest_spreads.py \
            --config RubberBand/config.yaml \
            --tickers "${{ github.event.inputs.tickers || 'RubberBand/tickers_options.txt' }}" \
            --days "${{ github.event.inputs.days || '30' }}" \
            --dte "${{ github.event.inputs.dte || '6' }}" \
            --spread-width "${{ github.event.inputs.spread_width || '1.5' }}" \
            --sma-period "${{ github.event.inputs.sma_period || '20' }}" \
            --max-debit "${{ github.event.inputs.max_debit || '2.0' }}" \
            --bars-stop "${{ github.event.inputs.bars_stop || '10' }}" \
            --adx-max "${{ github.event.inputs.adx_max || '0' }}" \
            --sl-pct "${{ github.event.inputs.sl_pct || '0.80' }}" \
            $SLOPE_ARG \
            $SLOPE10_ARG \
            ${{ github.event.inputs.verbose == 'true' && '--verbose' || '' }} \
            ${{ github.event.inputs.flatten_eod == 'true' && '--flatten-eod' || '' }}

      - name: Upload Backtest Results
        uses: actions/upload-artifact@v4
        with:
          name: 15m-options-backtest-${{ github.run_id }}
          path: |
            results/spread_backtest_trades.csv
            results/spread_backtest_summary.json
          if-no-files-found: warn
          retention-days: 30

