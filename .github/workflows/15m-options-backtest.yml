name: 15-Minute Options Spread Backtest

on:
  workflow_dispatch:
    inputs:
      days:
        description: 'Backtest period (days)'
        required: false
        default: '30'
        type: string
      dte:
        description: 'Days to expiration (1-3)'
        required: false
        default: '2'
        type: string
      spread_width:
        description: 'Spread width in ATR multiples'
        required: false
        default: '1.5'
        type: string
      max_debit:
        description: 'Max debit per share ($)'
        required: false
        default: '1.0'
        type: string
      tickers:
        description: 'Ticker file path'
        required: false
        default: 'RubberBand/tickers_options.txt'
        type: string

jobs:
  backtest:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r RubberBand/requirements.txt

      - name: Run 15-Minute Options Spread Backtest
        env:
          APCA_API_KEY_ID: ${{ secrets.ALPACA_KEY_ID }}
          APCA_API_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
          APCA_API_BASE_URL: https://paper-api.alpaca.markets
        run: |
          echo "=========================================="
          echo "15-Minute Options Spread Backtest"
          echo "=========================================="
          echo "Period: ${{ github.event.inputs.days || '30' }} days"
          echo "DTE: ${{ github.event.inputs.dte || '2' }}"
          echo "Spread Width: ${{ github.event.inputs.spread_width || '1.5' }} ATR"
          echo "Max Debit: ${{ github.event.inputs.max_debit || '1.0' }}"
          echo "Tickers: ${{ github.event.inputs.tickers || 'RubberBand/tickers_options.txt' }}"
          echo "=========================================="
          
          python RubberBand/scripts/backtest_spreads.py \
            --config RubberBand/config.yaml \
            --tickers "${{ github.event.inputs.tickers || 'RubberBand/tickers_options.txt' }}" \
            --days "${{ github.event.inputs.days || '30' }}" \
            --dte "${{ github.event.inputs.dte || '2' }}" \
            --spread-width "${{ github.event.inputs.spread_width || '1.5' }}" \
            --max-debit "${{ github.event.inputs.max_debit || '1.0' }}"

      - name: Upload Backtest Results
        uses: actions/upload-artifact@v4
        with:
          name: 15m-options-backtest-${{ github.run_id }}
          path: |
            results/spread_backtest_trades.csv
            results/spread_backtest_summary.json
          if-no-files-found: warn
          retention-days: 30
