name: "[BACKTEST] Weekly Stock"

on:
  # Manual trigger with configurable weeks parameter
  workflow_dispatch:
    inputs:
      weeks:
        description: 'Number of calendar weeks to backtest (default: 26)'
        required: false
        default: '26'
        type: string
      tickers:
        description: 'Ticker file to use'
        required: false
        default: 'RubberBand/tickers_weekly.txt'
        type: string
      adx_max:
        description: 'Max ADX to allow entry (0=disabled, try 50-60)'
        required: false
        default: '0'
        type: string

jobs:
  backtest:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f RubberBand/requirements.txt ]; then pip install -r RubberBand/requirements.txt; fi
          pip install pandas requests pyyaml numpy
      
      - name: Run Weekly Backtest
        env:
          ALPACA_KEY_ID: ${{ secrets.ALPACA_KEY_ID }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
          APCA_API_BASE_URL: https://paper-api.alpaca.markets
        run: |
          # Convert weeks to days (add 365 extra days for indicator warmup: 50-week SMA needs ~350 days)
          WEEKS=${{ github.event.inputs.weeks || '26' }}
          DAYS=$((WEEKS * 7))
          
          echo "========================================"
          echo "Weekly Strategy Backtest"
          echo "========================================"
          echo "Weeks: $WEEKS"
          echo "Days: $DAYS"
          echo "Tickers: ${{ github.event.inputs.tickers || 'RubberBand/tickers_weekly.txt' }}"
          echo "========================================"
          
          python RubberBand/scripts/backtest_weekly.py \
            --days $DAYS \
            --tickers ${{ github.event.inputs.tickers || 'RubberBand/tickers_weekly.txt' }} \
            --config RubberBand/config_weekly.yaml \
            --adx-max "${{ github.event.inputs.adx_max || '0' }}"
      
      - name: Upload Backtest Results
        uses: actions/upload-artifact@v4
        with:
          name: weekly-backtest-results-${{ github.event.inputs.weeks || '26' }}weeks
          path: |
            weekly_backtest_summary.csv
            weekly_detailed_trades.csv
          if-no-files-found: warn
