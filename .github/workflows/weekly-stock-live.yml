name: "[BOT] Weekly Stock - Live"

on:
  schedule:
    # Hourly during market hours (UTC 14:35-20:35 = ~9:35 AM - 3:35 PM ET)
    # Monday: full scan + entries + position monitoring
    # Tue-Fri: position monitoring + time-stop checks
    - cron: '35 14 * * 1-5'   # 9:35 AM ET
    - cron: '35 15 * * 1-5'   # 10:35 AM ET
    - cron: '35 16 * * 1-5'   # 11:35 AM ET
    - cron: '35 17 * * 1-5'   # 12:35 PM ET
    - cron: '35 18 * * 1-5'   # 1:35 PM ET
    - cron: '35 19 * * 1-5'   # 2:35 PM ET
    - cron: '35 20 * * 1-5'   # 3:35 PM ET
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run mode (1=simulate, 0=live paper trading)'
        required: false
        default: '0'
        type: string

permissions:
  contents: write

concurrency:
  group: weekly-stock-trading
  cancel-in-progress: true

jobs:
  trade:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f RubberBand/requirements.txt ]; then pip install -r RubberBand/requirements.txt; fi
          pip install pandas requests pyyaml numpy alpaca-trade-api

      # Position registry is persisted via git commits (GAP-008 fix)
      # checkout@v4 above retrieves the latest registry from git automatically
      # Artifact-based download was removed as it only works within same workflow run

      - name: Run Weekly Stock Trading
        env:
          APCA_API_KEY_ID: ${{ secrets.ALPACA_KEY_ID }}
          APCA_API_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
          APCA_API_BASE_URL: https://paper-api.alpaca.markets
          PYTHONPATH: ${{ github.workspace }}
          PYTHONUNBUFFERED: "1"
        run: |
          # Configure git for registry persistence (GAP-008)
          git config user.email "bot@rubberband.local"
          git config user.name "RubberBandBot"

          DRY_RUN=${{ github.event.inputs.dry_run || '0' }}

          # Determine day of week (Monday = 1)
          DAY_OF_WEEK=$(TZ=America/New_York date +%u)
          HOUR_ET=$(TZ=America/New_York date +%H)

          echo "========================================"
          echo "Weekly Stock Trading V2 (single-cycle)"
          echo "========================================"
          echo "Day of Week: $DAY_OF_WEEK (1=Monday)"
          echo "Hour (ET): $HOUR_ET"
          echo "Dry Run: $DRY_RUN"
          echo "========================================"

          # Create logs directory
          mkdir -p logs

          # Run a single trading cycle and exit
          set -o pipefail
          python RubberBand/scripts/live_weekly_loop.py 2>&1 | tee console.log

      - name: Commit Position Registry to Git
        if: always()
        run: |
          if [ -f .position_registry/WK_STK_positions.json ]; then
            git add .position_registry/WK_STK_positions.json
            git diff --cached --quiet && echo "No registry changes to commit" && exit 0
            git commit -m "[AUTO] WK_STK registry update $(TZ=America/New_York date '+%Y-%m-%d %H:%M')"
            git pull origin main --rebase --autostash || true
            git push || echo "WARNING: git push failed, registry saved locally only"
          fi

      - name: Upload Trade Logs
        uses: actions/upload-artifact@v4
        with:
          name: weekly-stock-trades-${{ github.run_id }}
          path: logs/weekly_live_*.jsonl
          if-no-files-found: warn

      - name: Upload Position Registry (backup)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: position-registry-WK_STK
          path: .position_registry/WK_STK_positions.json
          if-no-files-found: warn
          retention-days: 90
          overwrite: true

      - name: Upload Console Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: weekly-stock-console-log-${{ github.run_id }}
          path: console.log
          if-no-files-found: warn
          retention-days: 30
