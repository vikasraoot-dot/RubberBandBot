name: "[BOT] Auditor - Shadow Ledger"

on:
  schedule:
    # Run every 20 minutes during market hours (offset from bot cycles)
    # 14:05, 14:25, 14:45 ... 21:05 UTC = ~9:05 AM - 4:05 PM EST
    - cron: "5,25,45 14-21 * * 1-5"
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run mode (1=no shadow trades, 0=full shadow portfolio)'
        required: false
        default: '0'

concurrency:
  group: auditor-shadow-ledger
  cancel-in-progress: false  # Don't cancel - we want continuous monitoring

permissions:
  contents: write  # Required for git push

jobs:
  audit:
    runs-on: [self-hosted, windows]
    timeout-minutes: 15

    steps:
      - name: Checkout with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull Latest Commits
        shell: powershell
        run: |
          $ErrorActionPreference = "Continue"
          git config user.email "bot@rubberband.local"
          git config user.name "RubberBandBot-Auditor"
          $pullResult = git pull origin main --rebase 2>&1
          if ($LASTEXITCODE -ne 0) {
            $pullResult = git pull origin main 2>&1
            if ($LASTEXITCODE -ne 0) {
              Write-Host "Pull failed, continuing with local checkout"
            }
          }

      - name: Ensure Python path
        shell: powershell
        run: |
          $python = (Get-Command python.exe).Source
          echo "PYTHON_EXE=$python" >> $env:GITHUB_ENV

      - name: Install deps
        shell: powershell
        run: |
          & "$env:PYTHON_EXE" -m pip install --upgrade pip --quiet
          & "$env:PYTHON_EXE" -m pip install -r RubberBand/requirements.txt --quiet

      - name: Run Auditor Bot
        shell: powershell
        env:
          APCA_BASE_URL: https://paper-api.alpaca.markets
          APCA_API_KEY_ID: ${{ secrets.ALPACA_KEY_ID }}
          APCA_API_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
          PYTHONUNBUFFERED: "1"
        run: |
          $env:PYTHONPATH = "$env:GITHUB_WORKSPACE"
          $dryRun = if ("${{ github.event.inputs.dry_run }}" -ne "") { "${{ github.event.inputs.dry_run }}" } else { "0" }
          
          Write-Host "=== Auditor Bot Starting ==="
          Write-Host "Log Directory: auditor_logs/"
          Write-Host "Dry Run: $dryRun"
          
          # Run auditor with log directory argument
          & "$env:PYTHON_EXE" -u RubberBand/scripts/auditor_bot.py --log-dir auditor_logs --single-pass
          
          Write-Host "=== Auditor Bot Complete ==="

      - name: Commit Auditor Results
        if: always()
        shell: powershell
        run: |
          $ErrorActionPreference = "Continue"
          $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm"
          
          # Check if any auditor output files exist
          $hasState = Test-Path "auditor_state.json"
          $hasLog = Test-Path "auditor_log.csv"
          
          if ($hasState -or $hasLog) {
            if ($hasState) { git add auditor_state.json }
            if ($hasLog) { git add auditor_log.csv }
            git commit -m "[AUDITOR] Shadow Ledger Update $timestamp" 2>$null
            if ($LASTEXITCODE -eq 0) {
              $pushResult = git push 2>&1
              if ($LASTEXITCODE -ne 0) {
                Write-Host "Push failed (concurrent edit?)"
              } else {
                Write-Host "Auditor results committed successfully"
              }
            } else {
              Write-Host "No changes to commit (state unchanged)"
            }
          } else {
            Write-Host "No auditor output files found (first run with no logs to process)"
          }
          # Always exit success - no changes is not an error
          exit 0

      - name: Upload Auditor State
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: auditor-state-${{ github.run_id }}
          path: |
            auditor_state.json
            auditor_log.csv
          if-no-files-found: warn
          retention-days: 30
