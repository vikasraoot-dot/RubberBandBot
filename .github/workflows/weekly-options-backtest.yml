name: "[BACKTEST] Weekly Options"

on:
  # Manual trigger with configurable parameters
  workflow_dispatch:
    inputs:
      weeks:
        description: 'Number of calendar weeks to backtest (default: 52)'
        required: false
        default: '52'
        type: string
      tickers:
        description: 'Ticker file to use'
        required: false
        default: 'RubberBand/tickers_weekly.txt'
        type: string
      adx_max:
        description: 'Max ADX to allow entry (0=disabled, try 50-60)'
        required: false
        default: '0'
        type: string

jobs:
  backtest:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f RubberBand/requirements.txt ]; then pip install -r RubberBand/requirements.txt; fi
          pip install pandas requests pyyaml numpy yfinance
      
      - name: Run Weekly Options Backtest
        env:
          ALPACA_KEY_ID: ${{ secrets.ALPACA_KEY_ID }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
          APCA_API_BASE_URL: https://paper-api.alpaca.markets
        run: |
          WEEKS=${{ github.event.inputs.weeks || '52' }}
          DAYS=$((WEEKS * 7))
          TICKERS=${{ github.event.inputs.tickers || 'RubberBand/tickers_weekly.txt' }}
          
          echo "========================================"
          echo "Weekly Options Backtest (Simulated)"
          echo "========================================"
          echo "Weeks: $WEEKS ($DAYS days)"
          echo "Tickers: $TICKERS"
          echo "========================================"
          
          set -o pipefail
          python RubberBand/scripts/backtest_weekly_options.py \
            --days $DAYS \
            --tickers $TICKERS \
            --adx-max "${{ github.event.inputs.adx_max || '0' }}" 2>&1 | tee console.log
      
      - name: Upload Backtest Results
        uses: actions/upload-artifact@v4
        with:
          name: weekly-options-backtest-${{ github.event.inputs.weeks || '52' }}weeks
          path: |
            weekly_options_backtest.csv
            weekly_options_summary.txt
          if-no-files-found: warn
