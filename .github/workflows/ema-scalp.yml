name: EMA Momentum Scalper

on:
  # Market hours: Mon-Fri, 9:25 AM ET = 14:25 UTC
  schedule:
    - cron: '25 14 * * 1-5'

  # Manual trigger
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (signals only, no orders)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      max_positions:
        description: 'Max concurrent positions'
        required: false
        default: '8'
      max_daily_loss:
        description: 'Max daily loss ($)'
        required: false
        default: '150'

# Only one instance at a time
concurrency:
  group: ema-scalp-bot
  cancel-in-progress: false

jobs:
  run-ema-scalp:
    name: EMA Scalp Bot
    runs-on: self-hosted
    timeout-minutes: 420  # 7 hours (full trading day + buffer)

    env:
      APCA_API_KEY_ID: ${{ secrets.APCA_API_KEY_ID }}
      APCA_API_SECRET_KEY: ${{ secrets.APCA_API_SECRET_KEY }}
      PYTHONUNBUFFERED: '1'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Find Python
        id: find-python
        run: |
          # Find a working Python 3 on this self-hosted runner
          $pythonPaths = @(
            "python",
            "python3",
            "C:\Python313\python.exe",
            "C:\Python311\python.exe",
            "C:\Python310\python.exe"
          )
          $found = $false
          foreach ($p in $pythonPaths) {
            try {
              $ver = & $p --version 2>&1
              if ($ver -match "Python 3") {
                Write-Host "Found Python: $p ($ver)"
                echo "PYTHON_CMD=$p" >> $env:GITHUB_OUTPUT
                $found = $true
                break
              }
            } catch { }
          }
          if (-not $found) {
            Write-Host "ERROR: No Python 3 found on this runner"
            exit 1
          }

      - name: Install dependencies
        run: |
          $py = "${{ steps.find-python.outputs.PYTHON_CMD }}"
          if (-not $py) { $py = "python" }
          & $py -m pip install --upgrade pip
          & $py -m pip install -r ScalpingBots/requirements.txt

      - name: Verify API connectivity
        run: |
          $py = "${{ steps.find-python.outputs.PYTHON_CMD }}"
          if (-not $py) { $py = "python" }
          & $py ScalpingBots/scripts/verify_api.py

      - name: Run EMA Scalp Bot
        run: |
          $py = "${{ steps.find-python.outputs.PYTHON_CMD }}"
          if (-not $py) { $py = "python" }

          Write-Host "Starting EMA Momentum Scalper..."
          $DryRun = "${{ github.event.inputs.dry_run || 'false' }}"
          $MaxPos = "${{ github.event.inputs.max_positions || '8' }}"
          $MaxLoss = "${{ github.event.inputs.max_daily_loss || '150' }}"

          Write-Host "Python: $py"
          Write-Host "Dry Run: $DryRun"
          Write-Host "Max Positions: $MaxPos"
          Write-Host "Max Daily Loss: $MaxLoss"
          Write-Host "---"

          $botArgs = @("-m", "ScalpingBots.scripts.live_ema_scalp", "--max-positions", $MaxPos, "--max-daily-loss", $MaxLoss)

          if ($DryRun -eq "true") {
            $botArgs += "--dry-run"
          }

          & $py @botArgs

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ema-scalp-logs-${{ github.run_number }}
          path: ScalpingBots/logs/
          retention-days: 30
          if-no-files-found: ignore
