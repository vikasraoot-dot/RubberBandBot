name: EMA Momentum Scalper

on:
  # Market hours: Mon-Fri, 9:25 AM ET = 14:25 UTC
  schedule:
    - cron: '25 14 * * 1-5'

  # Manual trigger
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (signals only, no orders)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      max_positions:
        description: 'Max concurrent positions'
        required: false
        default: '8'
      max_daily_loss:
        description: 'Max daily loss ($)'
        required: false
        default: '150'

# Only one instance at a time
concurrency:
  group: ema-scalp-bot
  cancel-in-progress: false

jobs:
  run-ema-scalp:
    name: EMA Scalp Bot
    runs-on: self-hosted
    timeout-minutes: 420  # 7 hours (full trading day + buffer)
    defaults:
      run:
        shell: bash

    env:
      APCA_API_KEY_ID: ${{ secrets.APCA_API_KEY_ID }}
      APCA_API_SECRET_KEY: ${{ secrets.APCA_API_SECRET_KEY }}
      PYTHONUNBUFFERED: '1'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: |
            ScalpingBots/requirements.txt
            RubberBand/requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r ScalpingBots/requirements.txt

      - name: Verify API connectivity
        run: python ScalpingBots/scripts/verify_api.py

      - name: Run EMA Scalp Bot
        run: |
          echo "Starting EMA Momentum Scalper..."
          DRY_RUN="${{ github.event.inputs.dry_run || 'false' }}"
          MAX_POS="${{ github.event.inputs.max_positions || '8' }}"
          MAX_LOSS="${{ github.event.inputs.max_daily_loss || '150' }}"

          echo "Dry Run: $DRY_RUN"
          echo "Max Positions: $MAX_POS"
          echo "Max Daily Loss: $MAX_LOSS"
          echo "---"

          ARGS="--max-positions $MAX_POS --max-daily-loss $MAX_LOSS"

          if [ "$DRY_RUN" = "true" ]; then
            ARGS="$ARGS --dry-run"
          fi

          python -m ScalpingBots.scripts.live_ema_scalp $ARGS

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ema-scalp-logs-${{ github.run_number }}
          path: ScalpingBots/logs/
          retention-days: 30
          if-no-files-found: ignore
