name: Unified Bot Ticker Scanner

on:
  workflow_dispatch:
    inputs:
      bot_type:
        description: 'Bot type to scan for'
        type: choice
        options:
          - ALL
          - 15M_STK
          - 15M_OPT
          - WK_STK
          - WK_OPT
        default: 'ALL'
      price_min:
        description: 'Minimum price ($) - Default: $20'
        required: false
        default: '20'
        type: string
      price_max:
        description: 'Maximum price ($) - Default: $1000'
        required: false
        default: '1000'
        type: string
      atr_min:
        description: 'Minimum ATR% - Default: 2.0'
        required: false
        default: '2.0'
        type: string
      atr_max:
        description: 'Maximum ATR% - Default: 6.0'
        required: false
        default: '6.0'
        type: string
      volume_min:
        description: 'Minimum daily dollar volume ($M) - Default: $20M'
        required: false
        default: '20'
        type: string
      sma_period:
        description: 'SMA period (20 for 15M, 120 for Weekly/ALL)'
        required: false
        default: '120'
        type: string
      skip_options_check:
        description: 'Skip options availability check (faster)'
        type: boolean
        default: false
      tickers:
        description: 'Ticker file path'
        required: false
        default: 'tickers_full_list.txt'
        type: string

jobs:
  scan:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r RubberBand/requirements.txt

      - name: Run Unified Bot Scanner
        env:
          APCA_API_KEY_ID: ${{ secrets.ALPACA_KEY_ID }}
          APCA_API_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
          APCA_API_BASE_URL: https://paper-api.alpaca.markets
        run: |
          echo "=========================================="
          echo "Unified Bot Ticker Scanner"
          echo "=========================================="
          echo "Bot Type: ${{ github.event.inputs.bot_type || 'ALL' }}"
          echo "Tickers: ${{ github.event.inputs.tickers || 'tickers_full_list.txt' }}"
          echo "=========================================="
          
          # Build command with optional overrides
          CMD="python RubberBand/scripts/scan_for_bot.py"
          CMD="$CMD --bot-type ${{ github.event.inputs.bot_type || 'ALL' }}"
          CMD="$CMD --tickers ${{ github.event.inputs.tickers || 'tickers_full_list.txt' }}"
          CMD="$CMD --output scan_results.csv"
          
          # Add optional overrides if provided
          if [ -n "${{ github.event.inputs.price_min }}" ]; then
            CMD="$CMD --price-min ${{ github.event.inputs.price_min }}"
          fi
          if [ -n "${{ github.event.inputs.price_max }}" ]; then
            CMD="$CMD --price-max ${{ github.event.inputs.price_max }}"
          fi
          if [ -n "${{ github.event.inputs.atr_min }}" ]; then
            CMD="$CMD --atr-min ${{ github.event.inputs.atr_min }}"
          fi
          if [ -n "${{ github.event.inputs.atr_max }}" ]; then
            CMD="$CMD --atr-max ${{ github.event.inputs.atr_max }}"
          fi
          if [ -n "${{ github.event.inputs.volume_min }}" ]; then
            CMD="$CMD --volume-min ${{ github.event.inputs.volume_min }}"
          fi
          if [ -n "${{ github.event.inputs.sma_period }}" ]; then
            CMD="$CMD --sma-period ${{ github.event.inputs.sma_period }}"
          fi
          if [ "${{ github.event.inputs.skip_options_check }}" = "true" ]; then
            CMD="$CMD --skip-options-check"
          fi
          
          echo "Running: $CMD"
          eval $CMD

      - name: Upload Scan Results
        uses: actions/upload-artifact@v4
        with:
          name: bot-scan-results-${{ github.run_id }}
          path: |
            scan_results.csv
            RubberBand/tickers_*_scan.txt
          if-no-files-found: warn
          retention-days: 30
